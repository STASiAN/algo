---
- name: Cloud only tasks
  block:
  - name: Install software updates
    yum:
      update_cache: true
      install_recommends: true
      upgrade: dist

  - name: Upgrade the ca certificates
    yum:
      name: ca-certificates
      state: latest

  - name: Check if reboot is required
    shell: >
      if [[ -e /var/run/reboot-required ]]; then echo "required"; else echo "no"; fi
    args:
      executable: /bin/bash
    register: reboot_required

  - name: Reboot
    shell: sleep 2 && shutdown -r now "Ansible updates triggered"
    async: 1
    poll: 0
    when: reboot_required is defined and reboot_required.stdout == 'required'
    ignore_errors: true

  - name: Wait until SSH becomes ready...
    local_action:
      module: wait_for
      port: 22
      host: "{{ inventory_hostname }}"
      search_regex: OpenSSH
      delay: 10
      timeout: 320
    when: reboot_required is defined and reboot_required.stdout == 'required'
    become: false

  - name: Include unatteded upgrades configuration
    include_tasks: unattended-upgrades.yml

  - name: Disable MOTD on login and SSHD
    replace: dest="{{ item.file }}" regexp="{{ item.regexp }}" replace="{{ item.line }}"
    with_items:
      - { regexp: '^session.*optional.*pam_motd.so.*', line: '# MOTD DISABLED', file: '/etc/pam.d/login' }
      - { regexp: '^session.*optional.*pam_motd.so.*', line: '# MOTD DISABLED', file: '/etc/pam.d/sshd' }
  tags:
    - cloud

- name: Loopback for services configured
  template:
    src: 10-algo-centos-lo100.network.j2
    dest: /etc/sysconfig/network-scripts/ifcfg-lo:100
  notify:
    - restart network
  tags:
    - always

- meta: flush_handlers
  tags:
    - always

- name: Check selinux support
  shell: sestatus
  ignore_errors: yes
  register: selinux_status

- set_fact:
    selinux_enabled: true
  when: '"Current mode:                   enforcing" in selinux_status.stdout'

- set_fact:
    tools:
      - git
      - screen
      - coreutils
      - libcgroup-tools
      - iptables-services
      - "openssl{% if install_headers|default(true)|bool %},kernel-headers-{{ ansible_kernel }}{% endif %}"
    sysctl:
      - item: net.ipv4.ip_forward
        value: 1
      - item: net.ipv4.conf.all.forwarding
        value: 1
      - item: net.ipv6.conf.all.forwarding
        value: 1
  tags:
    - always
